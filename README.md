# DALI-to-MQTT Bridge for ESP32

![ESP-IDF](https://img.shields.io/badge/ESP--IDF-v5.x-blue)
![Language](https://img.shields.io/badge/language-C++23-purple)

**daliMQTT** — это полнофункциональный мост между шиной управления освещением DALI и протоколом MQTT, разработанный для платформы ESP32 с использованием фреймворка ESP-IDF. Проект позволяет интегрировать профессиональные системы освещения DALI в современные системы умного дома, такие как Home Assistant, Node-RED и другие.

## Ключевые возможности

*   **Полное управление DALI**: Отправка команд яркости (DACP), включения/выключения, вызова сцен для отдельных устройств (short address) и групп (group address).
*   **Двусторонняя связь**: Опрос состояния светильников (уровень яркости, статус лампы) и отправка этих данных в MQTT.
*   **Гибкая настройка через Web-интерфейс**: Встроенный веб-сервер для простой первоначальной настройки WiFi, MQTT и учетных данных.
*   **Автообнаружение в Home Assistant**: Автоматическая публикация конфигурационных сообщений для интеграции светильников DALI в Home Assistant без ручной настройки.

## Аппаратные требования

1.  **Плата на базе ESP32**: Любая плата с модулем ESP32 (например, ESP32-DevKitC).
2.  **DALI Трансивер/Блок питания**: Специализированное устройство, которое обеспечивает питание шины DALI и преобразует логические уровни ESP32 в электрические сигналы DALI. Примеры: Mean Well L-C Bus Power Supply, кастомные решения на оптопарах.

## Программные требования

1.  **ESP-IDF v5.x**: [Инструкция по установке](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/index.html).
2.  **GCC** (xtensa-esp-elf-g++): Компилятор C/C++ поставляемый ESP-IDF
4. **Git**: Для клонирования репозитория.
4.  **Node.js и npm**: Для сборки фронтенда Web-интерфейса.

## Сборка и прошивка проекта

### 1. Клонирование репозитория

```bash
git clone <URL_ВАШЕГО_РЕПОЗИТОРИЯ>
cd daliMQTT
```

### 2. Конфигурация проекта

Все основные настройки вынесены в `menuconfig`. Вы можете изменить пины DALI, параметры по умолчанию и другие опции.

```bash
# Активируйте окружение ESP-IDF
. $HOME/esp/esp-idf/export.sh

# Запустите menuconfig
cmake -B build -DCMAKE_TOOLCHAIN_FILE=/path/to/esp-idf/tools/cmake/toolchain-esp32.cmake -DTARGET=esp32 -GNinja .
cmake --build build --target menuconfig
```
Основные настройки находятся в разделе `DALI MQTT Bridge Settings`.

### 3. Сборка и прошивка

Процесс состоит из трех шагов: сборка, прошивка основного приложения и прошивка файловой системы для Web UI.

```bash
# Сборка проекта
cmake --build build

# Прошивка основного приложения
cmake --build build --target flash

# Запуск монитора порта для просмотра логов
cmake --build build --target monitor
```

## Первоначальная настройка (Provisioning)

При первом запуске устройство не имеет данных для подключения к вашей сети. Оно перейдет в режим настройки:

1.  **Подключитесь к Wi-Fi сети**: Устройство создаст точку доступа с SSID `DALI-MQTT-Bridge` и паролем `bridge123` (можно изменить в `menuconfig`).
2.  **Откройте Web-интерфейс**: В браузере перейдите по адресу `http://192.168.4.1`.
3.  **Введите учетные данные**: По умолчанию `admin`/`admin`.
4.  **Заполните поля**:
    *   **WiFi Settings**: SSID и пароль вашей домашней Wi-Fi сети.
    *   **MQTT Settings**: URI вашего брокера (например, `mqtt://user:pass@192.168.1.100`), Client ID и базовый топик.
    *   **Web UI Authentication**: Новый логин и пароль для доступа к веб-интерфейсу.
5.  **Сохраните и перезагрузите**: Нажмите "Save and Restart". Устройство сохранит конфигурацию в NVS-память и перезагрузится, пытаясь подключиться к вашей сети.

## MQTT API

После успешной настройки мост начнет взаимодействовать с MQTT брокером.

### Управление светильниками (Command Topic)

Топик для отправки команд имеет структуру:
`{base_topic}/light/{type}/{id}/set`

*   `{base_topic}`: Базовый топик, указанный в настройках (по умолчанию `dali_bridge`).
*   `{type}`: `short` или `group`.
*   `{id}`: Адрес устройства (0-63) или группы (0-15).

**Пример payload (JSON):**

```json
{
  "state": "ON",
  "brightness": 254
}
```

*   `state`: `"ON"` или `"OFF"`.
*   `brightness`: `0`-`254`.

### Получение состояния (State Topic)

Мост периодически опрашивает устройства и публикует их состояние в топик:
`{base_topic}/light/{type}/{id}/state`

**Пример payload (JSON):**

```json
{
  "state": "ON",
  "brightness": 128
}
```

### Статус доступности (Availability Topic)

Мост сообщает о своем статусе в топике:
`{base_topic}/status`

*   Payload `online`: Мост подключен к MQTT.
*   Payload `offline`: Сообщение LWT (Last Will and Testament), отправляется брокером, если мост отключается.

## Разработка и тестирование

Проект содержит набор unit- и интеграционных тестов для обеспечения качества кода.

### Сборка тестов

Для сборки тестовой прошивки передайте флаг `BUILD_TESTS=ON` в команду CMake:

```bash
# Конфигурация для сборки тестов
cmake -B build -G Ninja -DBUILD_TESTS=ON

# Сборка и запуск тестов
cmake --build build --target test
cmake --build build --target test-flash
cmake --build build --target test-monitor
```

## Структура проекта

```
.
├── esp32/                # Конфигурация ESP-IDF для основной прошивки
├── scripts/              # Вспомогательные CMake-скрипты
├── src/                  # Исходный код
│   ├── config/           # Менеджер конфигурации (NVS)
│   ├── dali/             # Высокоуровневый API для DALI
│   ├── driver/           # Низкоуровневый драйвер DALI (сабмодуль)
│   ├── lifecycle/        # Основная логика приложения (режимы работы)
│   ├── mqtt/             # MQTT клиент и логика автообнаружения
│   ├── webui/            # Исходный код Web-интерфейса (Vue.js + C++)
│   ├── wifi/             # Менеджер Wi-Fi соединений
│   └── main.cxx          # Точка входа в приложение
└── tests/                # Исходный код тестов
    ├── config/           # Тесты для ConfigManager
    ├── dali/             # Тесты для DaliAPI
    ...
    └── test_cases.c      # Точка входа для Unity
```
