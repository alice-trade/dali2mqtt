# DALI-to-MQTT Bridge for ESP

![ESP-IDF](https://img.shields.io/badge/ESP--IDF-v5.x-blue)
![Language](https://img.shields.io/badge/language-C++23-purple)

**daliMQTT** — это полнофункциональный мост между шиной управления освещением DALI и протоколом MQTT, разработанный для платформы ESP32 с использованием фреймворка ESP-IDF. Проект позволяет интегрировать профессиональные системы освещения DALI в современные системы умного дома, такие как Home Assistant, Node-RED и другие.

## Ключевые возможности

*   **Полное управление DALI**: Отправка команд яркости (DACP), включения/выключения, вызова сцен для отдельных устройств (short address) и групп (group address).
*   **Двусторонняя связь**: Опрос состояния светильников (уровень яркости, статус лампы) и отправка этих данных в MQTT.
*   **Пассивный мониторинг (Sniffer)**: Мост постоянно "слушает" шину DALI. Если команда отправлена с другого устройства (например, настенного DALI-пульта), мост зафиксирует это изменение и отправит актуальное состояние в MQTT, обеспечивая полную синхронизацию.
*   **Управление шиной DALI**:
    *   **Автоматическая адресация (Commissioning)**: Запуск процесса инициализации для обнаружения новых устройств на шине и автоматического назначения им коротких адресов.
    *   **Сканирование шины**: Возможность в любой момент найти все активные, уже адресованные устройства.
*   **Управление группами DALI**: Визуальное назначение устройств в любую из 16 групп DALI через Web-интерфейс. Управление группами также доступно через MQTT.
*   **Управление сценами DALI**: Полноценная поддержка 16 сцен DALI. Активация через MQTT, удобная настройка уровней яркости для каждого светильника в сцене через Web-интерфейс и автоматическое создание сущности `select` в Home Assistant для простого выбора сцен.
*   **Гибкая настройка через Web-интерфейс**: Встроенный веб-сервер для простой настройки WiFi/MQTT, а также для управления шиной DALI (сканирование, инициализация, группы, сцены).
*   **Автообнаружение в Home Assistant**: Автоматическая публикация конфигурационных сообщений для интеграции светильников и групп DALI в Home Assistant без ручной настройки.

## Аппаратные требования

1.  **Плата на базе ESP**: Любая плата с модулем ESP32-S3/ESP32-C3 (например, ESP32-S3-DevKitC).
2.  **DALI Трансивер/Блок питания**: Специализированное устройство, которое обеспечивает питание шины DALI и преобразует логические уровни ESP32 в электрические сигналы DALI. Примеры: Mean Well L-C Bus Power Supply, кастомные решения на оптопарах.

## Программные требования

1.  **ESP-IDF** : [Инструкция по установке](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/index.html).
2.  **GCC** (xtensa/riscv-esp-elf-g++): Компилятор C/C++ поставляемый ESP-IDF.
3.  **Git**: Для клонирования репозитория.
4.  **Node.js и npm**: Для сборки фронтенда Web-интерфейса.

## Сборка и прошивка проекта

### 1. Клонирование репозитория

```bash
git clone <URL_ВАШЕГО_РЕПОЗИТОРИЯ>
cd daliMQTT
```

### 2. Конфигурация проекта

Все основные настройки вынесены в `menuconfig`. Вы можете изменить пины DALI, параметры по умолчанию и другие опции.

```bash
# Активируйте окружение ESP-IDF
. $HOME/esp/esp-idf/export.sh

# Запустите menuconfig
cmake -B build -DCMAKE_TOOLCHAIN_FILE=/path/to/esp-idf/tools/cmake/toolchain-esp<chip>.cmake -GNinja .
cmake --build build --target menuconfig
```
Основные настройки находятся в разделе `DALI MQTT Bridge Settings`.

### 3. Сборка и прошивка

Процесс состоит из трех шагов: сборка, прошивка основного приложения и прошивка файловой системы для Web UI.

```bash
# Сборка проекта
cmake --build build

# Прошивка основного приложения
cmake --build build --target flash

# Запуск монитора порта для просмотра логов
cmake --build build --target monitor
```

## Первоначальная настройка (Provisioning)

При первом запуске устройство не имеет данных для подключения к вашей сети. Оно перейдет в режим настройки:

1.  **Подключитесь к Wi-Fi сети**: Устройство создаст точку доступа с SSID `DALI-MQTT-Bridge` и паролем `bridge123` (можно изменить в `menuconfig`).
2.  **Откройте Web-интерфейс**: В браузере перейдите по адресу `http://dalimqtt.local`.
3.  **Введите учетные данные**: По умолчанию `admin`/`admin`.
4.  **Заполните поля**:
    *   **WiFi Settings**: SSID и пароль вашей домашней Wi-Fi сети.
    *   **MQTT Settings**: URI вашего брокера (например, `mqtt://user:pass@192.168.1.100`), Client ID и базовый топик.
    *   **Web UI Authentication**: Новый логин и пароль для доступа к веб-интерфейсу.
5.  **Сохраните и перезагрузите**: Нажмите "Save and Restart". Устройство сохранит конфигурацию в NVS-память и перезагрузится, пытаясь подключиться к вашей сети.

## Настройка шины DALI

После того как устройство подключится к вашей сети, вы можете настроить устройства на шине DALI:
 
1.  **Откройте Web-интерфейс**: Перейдите по IP-адресу устройства в вашей сети или по адресу `http://dalimqtt.local` (если mDNS работает в вашей сети).
2.  **Перейдите на вкладку "DALI Control"**.
3.  **Выберите действие**:
    *   **Scan Bus**: Используйте эту опцию, если ваши DALI устройства уже имеют назначенные короткие адреса. Система просканирует все 64 адреса и отобразит найденные.
    *   **Initialize New Devices**: Используйте эту опцию для новых устройств без адреса. Система запустит стандартную процедуру DALI commissioning, найдет все устройства без адреса и последовательно назначит им свободные короткие адреса (от 0 до 63).
    *   **Настройте группы (Groups)**: Перейдите на вкладку "Group Assignments", чтобы назначить каждое устройство в одну или несколько из 16 групп.
    *   **Настройте сцены (Scenes)**: Перейдите на вкладку "Scene Editor", чтобы задать уровни яркости для каждого устройства в каждой из 16 сцен. Настройки сохраняются непосредственно в память DALI балластов.
4.  Найденные устройства будут автоматически сохранены и начнут опрашиваться для отправки состояний в MQTT.

## MQTT API

После успешной настройки мост начнет взаимодействовать с MQTT брокером.

### Управление светильниками (Command Topic)

Топик для отправки команд имеет структуру:
`{base_topic}/light/{type}/{id}/set`

*   `{base_topic}`: Базовый топик, указанный в настройках (по умолчанию `dali_bridge`).
*   `{type}`: `short` или `group`.
*   `{id}`: Адрес устройства (0-63) или группы (0-15).

**Пример payload (JSON):**

```json
{
  "state": "ON",
  "brightness": 254
}
```

*   `state`: `"ON"` или `"OFF"`.
*   `brightness`: `0`-`254`.

### Получение состояния (State Topic)

Мост периодически опрашивает устройства и публикует их состояние в топик:
`{base_topic}/light/short/{id}/state`

**Пример payload (JSON):**

```json
{
  "state": "ON",
  "brightness": 128
}
```

### Управление сценами (Scene Command Topic)

Активация сцен DALI осуществляется отправкой команды в топик:
`{base_topic}/scene/set`

**Payload (Home Assistant):**

Home Assistant отправляет простое строковое значение, соответствующее выбранной опции:

```
Scene 5
```

**Payload (JSON):**

```json
{
  "scene": 5
}
```

*   `scene`: Номер сцены от `0` до `15`.

### Управление группами (Group Command Topic)

Добавление или удаление устройства из группы:
`{base_topic}/config/group/set`

**Пример payload (JSON):**

```json
{
  "short_address": 10,
  "group": 3,
  "state": "add"
}
```
*   `short_address`: Адрес устройства (0-63).
*   `group`: Номер группы (0-15).
*   `state`: `"add"` или `"remove"`.

Результат операции публикуется в топик `{base_topic}/config/group/result`.

### Статус доступности (Availability Topic)

Мост сообщает о своем статусе в топике:
`{base_topic}/status`

*   Payload `online`: Мост подключен к MQTT.
*   Payload `offline`: Сообщение LWT (Last Will and Testament), отправляется брокером, если мост отключается.

## Разработка и тестирование

Проект содержит набор unit- и интеграционных тестов для обеспечения качества кода.

### Сборка тестов

Для сборки тестовой прошивки передайте флаг `BUILD_TESTS=ON` в команду CMake:

```bash
# Конфигурация для сборки тестов
cmake -B build -G Ninja -DBUILD_TESTS=ON

# Сборка и запуск тестов
cmake --build build --target test
cmake --build build --target test-flash
cmake --build build --target test-monitor
```

## Структура проекта

```
.
├── esp32s3/              # Конфигурация ESP-IDF для прошивки ESP32-S3
├── scripts/              # Вспомогательные CMake-скрипты
├── src/DaliMQT           # Исходный код
│   ├── config/           # Менеджер конфигурации
│   ├── dali/             # Высокоуровневый API для DALI
│   │   └── driver/       # Низкоуровневый драйвер DALI на gptimer, GPIO  
│   ├── lifecycle/        # Координация работы модулей и режимов приложения
│   ├── mqtt/             # MQTT клиент и логика автообнаружения
│   ├── webui/            # Исходный код Web-интерфейса (Vue.js + C++)
│   ├── wifi/             # Менеджер Wi-Fi соединений
│   └── main.cxx          # Точка входа в приложение
└── tests/                # Исходный код тестов
    ├── config/           # Тесты для ConfigManager
    ├── dali/             # Тесты для DaliAPI
    ...
    └── test_cases.c      # Точка входа для Unity
```